<header>
  <div class="logo">The <span>Vault</span></div>
  <div class="auth-btns" id="auth-ui">
    <button class="btn-user" onclick="openModal()">Login / Sign Up</button>
  </div>
</header>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, setDoc, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  // Your Config
  const firebaseConfig = {
    apiKey: "AIzaSyAppd2GsEJyzdN8TxOLCmFOiSXikkXQAuM",
    authDomain: "the-vault-1ea3a.firebaseapp.com",
    projectId: "the-vault-1ea3a",
    storageBucket: "the-vault-1ea3a.firebasestorage.app",
    messagingSenderId: "780186978448",
    appId: "1:780186978448:web:cf80b8c1bb6f70d3b3b015"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const ADMIN_UID = "6eMRv5PgObXsKys66yNzOYRLWGp2";
  let currentUser = null;

  // --- LOGOUT FIX: Attach to window so HTML can see it ---
  window.handleLogout = () => {
    signOut(auth).then(() => {
      location.reload(); // Refresh to clear admin states
    }).catch((error) => alert(error.message));
  };

  // --- AUTH OBSERVER ---
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    const ui = document.getElementById('auth-ui');
    const authForms = document.querySelectorAll('.auth-only'); // Meshes/Movesets
    const tutorialForm = document.querySelector('#tab-tutorials .upload-box');

    if(user) {
      const snap = await getDoc(doc(db, "users", user.uid));
      if(snap.exists() && snap.data().isBanned) { 
        alert("Banned."); signOut(auth); return; 
      }

      // Show standard upload forms for everyone logged in
      authForms.forEach(f => f.style.display = 'block');

      // ONLY show Tutorial upload for Admin
      if(tutorialForm) {
        tutorialForm.style.display = (user.uid === ADMIN_UID) ? 'block' : 'none';
      }

      // UI Update with Admin Page link
      ui.innerHTML = `
        <span style="font-size:0.8rem; color:var(--muted)">${user.email.split('@')[0]}</span>
        ${user.uid === ADMIN_UID ? '<span class="admin-badge">Admin</span>' : ''}
        ${user.uid === ADMIN_UID ? '<a href="admin.html" class="btn-user" style="text-decoration:none; background:var(--purple)">Admin Panel</a>' : ''}
        <button class="btn-user" onclick="handleLogout()">Logout</button>
      `;
    } else {
      authForms.forEach(f => f.style.display = 'none');
      if(tutorialForm) tutorialForm.style.display = 'none';
      ui.innerHTML = `<button class="btn-user" onclick="openModal()">Login / Sign Up</button>`;
    }
  });

  // --- GLOBAL FUNCTIONS ---
  window.openModal = () => document.getElementById('auth-modal').classList.add('show');
  window.closeModal = () => document.getElementById('auth-modal').classList.remove('show');
  
  window.handleAuth = async (type) => {
    const email = document.getElementById('auth-email').value;
    const pass = document.getElementById('auth-pass').value;
    try {
      if(type === 'signup') {
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", res.user.uid), { email, isBanned: false });
      } else { await signInWithEmailAndPassword(auth, email, pass); }
      closeModal();
    } catch(e) { alert(e.message); }
  };

  // Re-link the submission functions
  window.submitMesh = async () => { /* Same as before */ };
  window.submitMoveset = async () => { /* Same as before */ };
  window.submitTutorial = async () => {
    if(currentUser.uid !== ADMIN_UID) return alert("Unauthorized");
    const url = document.getElementById('t-url').value;
    const vidId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
    await addDoc(collection(db, "tutorials"), { 
      name: document.getElementById('t-name').value, 
      url, 
      vidId, 
      userId: currentUser.uid, 
      createdAt: Date.now() 
    });
    alert("Tutorial Added!");
  };
</script>
