<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>The Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --bg:#0f0e17; --surface:#1a1826; --card:#211f32; --border:#2e2b47;
            --text:#f0eeff; --muted:#7a758f; --pink:#ff6bcb; --cyan:#5ee7ff; --green:#7cff6b; --red:#ff4466; --yellow:#ffe566; --purple:#b16bff;
        }
        body{background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;margin:0;overflow-x:hidden;}
        header{padding:1.1rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
        .logo{font-family:'Fredoka One',cursive;font-size:1.8rem;color:var(--cyan);}
        .logo span{color:var(--pink);}
        .auth-btns{display:flex;gap:10px;align-items:center;}
        .btn-user{background:var(--card);border:1px solid var(--border);color:white;padding:8px 15px;border-radius:8px;cursor:pointer;font-weight:800;font-size:0.85rem;}

        .tab-bar{display:flex;background:var(--surface);border-bottom:2px solid var(--border);overflow-x:auto;}
        .tab-btn{padding:1rem 1.5rem;background:none;border:none;color:var(--muted);font-weight:800;cursor:pointer;white-space:nowrap;}
        .tab-btn.active{color:var(--cyan);border-bottom:3px solid var(--cyan);}
        #admin-tab-btn { display:none; color: var(--purple); }

        .tab-panel{display:none;padding:2rem;max-width:1400px;margin:auto;}
        .tab-panel.active{display:block;}

        /* Admin UI Styles from your admin.html */
        .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem;}
        .stat-box{background:var(--card);border:2px solid var(--border);border-radius:15px;padding:1.5rem;text-align:center;}
        .stat-box h2 { font-family:'Fredoka One'; margin:0; color:var(--cyan); }
        .admin-card{background:var(--card);border:2px solid var(--border);border-radius:15px;padding:1.5rem;margin-bottom:1.5rem;}
        .q-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border);}
        .btn-action{padding:5px 10px;border-radius:5px;border:none;cursor:pointer;font-weight:bold;margin-left:5px;}
        
        /* General Site Styles */
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;}
        .card{background:var(--card);border:2px solid var(--border);border-radius:20px;overflow:hidden;}
        .thumb img{width:100%;aspect-ratio:1.2;object-fit:cover;}
        .card-body{padding:1.2rem;}
        .copy-btn{background:var(--surface);border:2px solid var(--border);padding:8px;border-radius:10px;cursor:pointer;color:white;width:100%;text-align:left;margin-top:10px;}
        .upload-box{margin-top:40px; background:var(--surface); padding:2rem; border-radius:20px; border:2px solid var(--border); display:none;}
        input, textarea, select{width:100%;padding:12px;background:var(--bg);border:2px solid var(--border);color:white;border-radius:10px;margin-bottom:12px;box-sizing:border-box;}
        .btn-main{width:100%;padding:14px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:var(--cyan);color:black;}

        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:1000;}
        .modal.show{display:flex;}
        .modal-content{background:var(--card);padding:2rem;border-radius:24px;width:350px;border:2px solid var(--border);text-align:center;}
    </style>
</head>
<body>

<header>
    <div class="logo">The <span>Vault</span></div>
    <div class="auth-btns" id="auth-ui">
        <button class="btn-user" onclick="window.openModal()">Login / Sign Up</button>
    </div>
</header>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="meshes">üß± Meshes</button>
    <button class="tab-btn" data-tab="movesets">‚öîÔ∏è Movesets</button>
    <button class="tab-btn" data-tab="tutorials">üì∫ Tutorials</button>
    <button class="tab-btn" data-tab="sounds">üîä Sounds</button>
    <button class="tab-btn" id="admin-tab-btn" data-tab="admin">üõ°Ô∏è Admin</button>
</div>

<div class="tab-panel active" id="tab-meshes"><div class="cards-grid" id="mesh-grid"></div>
    <div class="upload-box" id="mesh-upload"><h3>Submit Mesh</h3><input id="m-name" placeholder="Name"><input id="m-id" placeholder="Asset ID"><button class="btn-main" onclick="window.submitItem('meshes')">Post</button></div>
</div>
<div class="tab-panel" id="tab-admin">
    <div class="stat-grid">
        <div class="stat-box"><h2 id="stat-total">0</h2><div>Total Items</div></div>
        <div class="stat-box"><h2 id="stat-pending" style="color:var(--yellow)">0</h2><div>Pending</div></div>
        <div class="stat-box"><h2 id="stat-users" style="color:var(--pink)">0</h2><div>Users</div></div>
    </div>

    <div class="admin-card">
        <h3>‚è≥ Pending Queue</h3>
        <div id="admin-pending-list"></div>
    </div>

    <div class="admin-card">
        <h3>üë• User Management</h3>
        <div id="admin-user-list"></div>
    </div>

    <div class="admin-card">
        <h3>‚öôÔ∏è Site Settings</h3>
        <label>Require Approval for New Posts</label>
        <input type="checkbox" id="setting-approval" onchange="window.updateSetting('requireApproval', this.checked)">
    </div>
</div>

<div class="modal" id="auth-modal">
    <div class="modal-content">
        <h2>Vault Access</h2>
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-pass" placeholder="Password">
        <button class="btn-main" onclick="window.handleAuth('login')">Login</button>
        <button class="btn-main" style="background:var(--surface); color:white; margin-top:10px;" onclick="window.handleAuth('signup')">Sign Up</button>
        <button onclick="window.closeModal()" style="background:none; border:none; color:var(--muted); cursor:pointer; margin-top:10px;">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAppd2GsEJyzdN8TxOLCmFOiSXikkXQAuM",
        authDomain: "the-vault-1ea3a.firebaseapp.com",
        projectId: "the-vault-1ea3a",
        storageBucket: "the-vault-1ea3a.firebasestorage.app",
        messagingSenderId: "780186978448",
        appId: "1:780186978448:web:cf80b8c1bb6f70d3b3b015"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_UID = "6eMRv5PgObXsKys66yNzOYRLWGp2";
    let currentUser = null;

    // UI Helpers
    window.openModal = () => document.getElementById('auth-modal').classList.add('show');
    window.closeModal = () => document.getElementById('auth-modal').classList.remove('show');
    window.handleLogout = () => signOut(auth).then(() => location.reload());

    // Auth Logic
    window.handleAuth = async (type) => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            if(type === 'signup') {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", res.user.uid), { email, isBanned: false });
            } else { await signInWithEmailAndPassword(auth, email, pass); }
            window.closeModal();
        } catch(e) { alert(e.message); }
    };

    // Management Functions
    window.submitItem = async (col) => {
        const settings = (await getDoc(doc(db, "settings", "config"))).data();
        await addDoc(collection(db, col), {
            name: document.getElementById('m-name').value,
            assetId: document.getElementById('m-id').value,
            status: settings.requireApproval ? 'pending' : 'approved',
            userId: currentUser.uid,
            createdAt: Date.now()
        });
        alert("Submitted!");
    };

    window.approveItem = (col, id) => updateDoc(doc(db, col, id), { status: 'approved' });
    window.deleteItem = (col, id) => confirm("Delete?") && deleteDoc(doc(db, col, id));
    window.updateSetting = (key, val) => setDoc(doc(db, "settings", "config"), { [key]: val }, { merge: true });

    // Auth Observer
    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const adminBtn = document.getElementById('admin-tab-btn');
        if(user) {
            if(user.uid === ADMIN_UID) {
                adminBtn.style.display = 'block';
                loadAdminData();
            }
            document.getElementById('auth-ui').innerHTML = `<button class="btn-user" onclick="window.handleLogout()">Logout</button>`;
            document.querySelectorAll('.upload-box').forEach(b => b.style.display = 'block');
        }
    });

    // Sync Data
    const syncPublic = (col, gridId) => {
        onSnapshot(query(collection(db, col), where("status", "==", "approved")), (snap) => {
            document.getElementById(gridId).innerHTML = snap.docs.map(d => {
                const m = d.data();
                return `<div class="card">
                    <div class="thumb"><img src="https://thumbnails.roblox.com/v1/assets?assetIds=${m.assetId}&size=420x420&format=Png"></div>
                    <div class="card-body"><strong>${m.name}</strong><button class="copy-btn">ID: ${m.assetId}</button></div>
                </div>`;
            }).join('');
        });
    };

    function loadAdminData() {
        // Pending List
        onSnapshot(query(collection(db, "meshes"), where("status", "==", "pending")), (snap) => {
            document.getElementById('stat-pending').innerText = snap.size;
            document.getElementById('admin-pending-list').innerHTML = snap.docs.map(d => `
                <div class="q-item">
                    <span>üß± ${d.data().name}</span>
                    <div>
                        <button class="btn-action" style="background:var(--green)" onclick="window.approveItem('meshes','${d.id}')">Approve</button>
                        <button class="btn-action" style="background:var(--red)" onclick="window.deleteItem('meshes','${d.id}')">Reject</button>
                    </div>
                </div>
            `).join('');
        });
        
        // Settings Sync
        onSnapshot(doc(db, "settings", "config"), (doc) => {
            if(doc.exists()) document.getElementById('setting-approval').checked = doc.data().requireApproval;
        });
    }

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn, .tab-panel').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        };
    });

    syncPublic("meshes", "mesh-grid");
</script>
</body>
</html>
