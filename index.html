<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>The Vault</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --bg:#0f0e17; --surface:#1a1826; --card:#211f32; --border:#2e2b47;
            --text:#f0eeff; --muted:#7a758f; --pink:#ff6bcb; --cyan:#5ee7ff; --green:#7cff6b; --red:#ff4466; --yellow:#ffe566; --purple:#b16bff;
        }
        body{background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;margin:0;overflow-x:hidden;}
        header{padding:1.1rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
        .logo{font-family:'Fredoka One',cursive;font-size:1.8rem;color:var(--cyan);}
        .logo span{color:var(--pink);}
        .auth-btns{display:flex;gap:10px;align-items:center;}
        .btn-user{background:var(--card);border:1px solid var(--border);color:white;padding:8px 15px;border-radius:8px;cursor:pointer;font-weight:800;font-size:0.85rem;}
        .tab-bar{display:flex;background:var(--surface);border-bottom:2px solid var(--border);overflow-x:auto;}
        .tab-btn{padding:1rem 1.5rem;background:none;border:none;color:var(--muted);font-weight:800;cursor:pointer;white-space:nowrap;}
        .tab-btn.active{color:var(--cyan);border-bottom:3px solid var(--cyan);}
        .tab-panel{display:none;padding:2rem;max-width:1400px;margin:auto;}
        .tab-panel.active{display:block;}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;}
        .card{background:var(--card);border:2px solid var(--border);border-radius:20px;overflow:hidden;}
        .thumb{width:100%;aspect-ratio:1.2;background:var(--surface);display:flex;align-items:center;justify-content:center;}
        .thumb img{width:100%;height:100%;object-fit:cover;}
        .card-body{padding:1.2rem;display:flex;flex-direction:column;gap:10px;}
        .copy-btn{background:var(--surface);border:2px solid var(--border);padding:8px;border-radius:10px;cursor:pointer;color:white;text-align:left;}
        .btn-label{display:block;font-size:0.6rem;color:var(--cyan);font-weight:900;text-transform:uppercase;}
        .upload-box{margin-top:40px; background:var(--surface); padding:2rem; border-radius:20px; border:2px solid var(--border); display:none;}
        input, textarea{width:100%;padding:12px;background:var(--bg);border:2px solid var(--border);color:white;border-radius:10px;margin-bottom:12px;box-sizing:border-box;}
        .btn-main{width:100%;padding:14px;border-radius:12px;border:none;font-weight:900;cursor:pointer;background:var(--cyan);color:black;}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:1000;}
        .modal.show{display:flex;}
        .modal-content{background:var(--card);padding:2rem;border-radius:24px;width:350px;border:2px solid var(--border);text-align:center;}
        .admin-controls{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;gap:10px;}
        .del-btn{color:var(--red);background:none;border:none;cursor:pointer;font-size:0.7rem;font-weight:800;}
    </style>
</head>
<body>

<header>
    <div class="logo">The <span>Vault</span></div>
    <div class="auth-btns" id="auth-ui">
        <button class="btn-user" onclick="window.openModal()">Login / Sign Up</button>
    </div>
</header>

<div class="tab-bar">
    <button class="tab-btn active" data-tab="meshes">üß± Meshes</button>
    <button class="tab-btn" data-tab="movesets">‚öîÔ∏è JJS Movesets</button>
    <button class="tab-btn" data-tab="tutorials">üì∫ Tutorials</button>
    <button class="tab-btn" data-tab="sounds">üîä Sounds</button>
</div>

<div class="tab-panel active" id="tab-meshes">
    <div class="cards-grid" id="mesh-grid"></div>
    <div class="upload-box" id="mesh-upload">
        <h3>Submit Mesh</h3>
        <input id="m-name" placeholder="Name">
        <input id="m-assetid" placeholder="Asset ID">
        <button class="btn-main" onclick="window.submitMesh()">Post Mesh</button>
    </div>
</div>
<div class="modal" id="auth-modal">
    <div class="modal-content">
        <h2>Vault Access</h2>
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-pass" placeholder="Password">
        <button class="btn-main" onclick="window.handleAuth('login')">Login</button>
        <button class="btn-main" style="background:var(--surface); color:white; margin-top:10px;" onclick="window.handleAuth('signup')">Sign Up</button>
        <button onclick="window.closeModal()" style="margin-top:15px; background:none; border:none; color:var(--muted); cursor:pointer;">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAppd2GsEJyzdN8TxOLCmFOiSXikkXQAuM",
        authDomain: "the-vault-1ea3a.firebaseapp.com",
        projectId: "the-vault-1ea3a",
        storageBucket: "the-vault-1ea3a.firebasestorage.app",
        messagingSenderId: "780186978448",
        appId: "1:780186978448:web:cf80b8c1bb6f70d3b3b015"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_UID = "6eMRv5PgObXsKys66yNzOYRLWGp2";
    let currentUser = null;

    // ATTACH TO WINDOW FOR GITHUB COMPATIBILITY
    window.openModal = () => document.getElementById('auth-modal').classList.add('show');
    window.closeModal = () => document.getElementById('auth-modal').classList.remove('show');
    window.handleLogout = () => signOut(auth).then(() => location.reload());

    window.handleAuth = async (type) => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            if(type === 'signup') {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", res.user.uid), { email, isBanned: false });
            } else { await signInWithEmailAndPassword(auth, email, pass); }
            window.closeModal();
        } catch(e) { alert(e.message); }
    };

    // Submissions
    window.submitMesh = async () => {
        const id = document.getElementById('m-assetid').value;
        await addDoc(collection(db, "meshes"), { name: document.getElementById('m-name').value, assetId: id, meshId: "rbxassetid://" + id, textureId: "None", userId: currentUser.uid, createdAt: Date.now() });
        alert("Mesh Added!");
    };

    // Delete Item (Admin Only)
    window.deleteItem = async (col, id) => {
        if(confirm("Delete this?")) await deleteDoc(doc(db, col, id));
    };

    // Auth Observer
    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const ui = document.getElementById('auth-ui');
        const uploadBoxes = document.querySelectorAll('.upload-box');
        
        if(user) {
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists() && snap.data().isBanned) { alert("Banned."); signOut(auth); return; }

            uploadBoxes.forEach(box => {
                if(box.id === 'tutorial-upload') box.style.display = (user.uid === ADMIN_UID) ? 'block' : 'none';
                else box.style.display = 'block';
            });

            ui.innerHTML = `
                ${user.uid === ADMIN_UID ? '<a href="admin.html" class="btn-user" style="background:var(--purple); text-decoration:none;">Admin</a>' : ''}
                <button class="btn-user" onclick="window.handleLogout()">Logout</button>
            `;
        } else {
            uploadBoxes.forEach(box => box.style.display = 'none');
            ui.innerHTML = `<button class="btn-user" onclick="window.openModal()">Login</button>`;
        }
    });

    // Tab Switching Logic
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn, .tab-panel').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        };
    });

    // Real-time Sync
    const sync = (col, gridId) => {
        onSnapshot(query(collection(db, col), orderBy("createdAt", "desc")), (snap) => {
            document.getElementById(gridId).innerHTML = snap.docs.map(d => {
                const m = d.data();
                return `
                <div class="card">
                    <div class="thumb"><img src="https://thumbnails.roblox.com/v1/assets?assetIds=${m.assetId}&size=420x420&format=Png"></div>
                    <div class="card-body">
                        <strong>${m.name}</strong>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${m.meshId}')">
                            <span class="btn-label">Mesh ID</span>${m.meshId}
                        </button>
                        ${currentUser?.uid === ADMIN_UID ? `<div class="admin-controls"><button class="del-btn" onclick="window.deleteItem('${col}','${d.id}')">Delete</button></div>` : ''}
                    </div>
                </div>`;
            }).join('');
        });
    };
    sync("meshes", "mesh-grid");
</script>
</body>
</html>
